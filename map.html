<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    body {
      display: block;
      margin: 0px;
      overflow: hidden;
      padding: 0px;
    }
  </style>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
  <script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>
</head>
<body>

  <input type='text' value='' id='year'/> <button onclick='search()'> search</button>
  <!-- <button name='aaa'/> -->
  <div id="container"></div>
  <svg>
    <radialGradient id="tip">
      <stop offset="0" stop-color="white"/>
      <stop offset="0.2" stop-color="pink"/>
      <stop offset="1" stop-color="white"/>
    </radialGradient>
  </svg>
  <script type="text/javascript">


    

    var height = window.innerHeight;
    var width = window.innerWidth;
    var svg = d3.select('#container').append('svg');
    // var draw = function(mapdata, gdpdata) {
   
    // }
    var features = null;


    var search = function() {
        var year = document.getElementById('year').value;
        draw(year);
        
    };

    var draw = function(year) {
        var tmp = [];
        var cnt = 0;
        for (var i = 0; i < features.length; i++)
          if (features[i].gdps != null && features[i].gdps[year] > 0)
            tmp[cnt++] = features[i].gdps[year];
        var max = parseInt(d3.max(tmp))/10;
        var min = parseInt(d3.min(tmp))/10;
        
        var scale1 = d3.scale.linear().domain([min, max]).range([0, 255]);

           var projection = d3.geo.mercator()  
                            .center([0, 0])  
                            .scale(180)
                            .translate([width/2, height/2+10]); 
          var path = d3.geo.path()  
                    .projection(projection);  

          // svg.attr('width', width).attr('height', height);
          svg.selectAll('path')
            .attr('d', path)
            .on('mouseover', function(data) {
              d3.select(this).attr('fill', 'rgba(2,2,139,0.61)');
            })
           /* .on('mouseout', function(data) {
              // var gdp = null;
              // if (data.gdp) gdp = data.gdp[year];
              // if (gdp == -1 || gdp == null) 
                d3.select(this).attr('fill', 'rgba(128,124,139,0.61');
                // else d3.select(this).attr('fill', 'rgba(20,20,'+ scale1(gdp)+',0.61');
            })*/
            // .attr('fill', 'rgba(128,124,139,0.61)')
            .attr('fill', function(data) {
              // console.log(data);
              // d3.select(this).attr('fill', 'rgba(128,124,139,0.61');

              var gdp = null;
              if (data.gdps) gdp = data.gdps[year];
              console.log(scale1(gdp));
              if (gdp <= 0 || gdp == null) 
                return 'rgba(128,124,139,0.61)';
              console.log('rgba(120,120,'+ parseInt(scale1(gdp)) +',0.61)');
                return 'rgba(220,220,'+ parseInt(scale1(gdp/10)) +',0.61)';
                // else d3.select(this).attr('fill', 'rgba(20,20,'+ parseInt(scale1(parseInt(gdp)))+',0.61');
            })
            .attr('stroke', 'rgba(255,255,255,1)')
            .attr('stroke-width', 1);
    };

    d3.json("world-countries.json", function(data) {
        d3.json('gdp.json', function(data0) {
          




         features = _.filter(data.features, function(value, key) {
            return value.properties.name != 'Antarctica';
          });
          console.log(features.length);
          for (var i = 0; i < features.length; i++) {
            var tmp = features[i];
            var country = tmp.properties.name;
            tmp.gdps = data0[country];
            //alert(features[i].aa);
            //break;
            //alert(data0);
            //break;
            if (data0[country] == null)
               console.log(country);
         //break;
          }
         //for (var i = 0; i < ge)

          var projection = d3.geo.mercator()  
                            .center([0, 0])  
                            .scale(180)
                            .translate([width/2, height/2+10]); 

          var path = d3.geo.path()  
                    .projection(projection);  



          svg.attr('width', width).attr('height', height);
          svg.selectAll('path').data(features).enter().append('svg:path')
            .attr('d', path)
            .on('mouseover', function(data) {
              d3.select(this).attr('fill', 'rgba(2,2,139,0.61)');
            })
            .on('mouseout', function(data) {
              d3.select(this).attr('fill', 'rgba(128,124,139,0.61');
            })
            .attr('fill', 'rgba(128,124,139,0.61)')
            .attr('stroke', 'rgba(255,255,255,1)')
            .attr('stroke-width', 1);


        });
      
      
    });
  </script>

</body>
</html>
